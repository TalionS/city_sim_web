<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>City Simulation</title>
  <style>
    :root {
      --col-gap: 16px;
      --panel-w: 360px;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    canvas {
      border: 1px solid #ccc;
    }

    #layout {
      display: flex;
      gap: var(--col-gap);
      align-items: flex-start;
    }

    #leftCol {
      flex: 1;
      min-width: 520px;
    }

    #rightCol {
      width: var(--panel-w);
      flex: 0 0 var(--panel-w);
      position: sticky;
      top: 12px;
      align-self: flex-start;
    }

    #turnInfo {
      margin: 8px 0 12px;
      font-weight: bold;
    }

    .panel {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
    }

    .panel h3 {
      margin: 4px 0 8px;
      font-size: 16px;
    }

    .chart-wrap {
      width: 100%;
      height: 180px;
    }

    .chart-wrap canvas {
      width: 100% !important;
      height: 100% !important;
      border: none;
    }

    #color-legend {
      max-width: 760px;
      margin: 10px 0;
    }

    @media (max-width: 980px) {
      #layout {
        flex-direction: column;
      }

      #rightCol {
        width: 100%;
        position: static;
      }
    }
  </style>
</head>

<body>
  <h2>Interactive City Simulation</h2>

  <div id="layout">
    <div id="leftCol">
      <details id="how-to-read" style="max-width:760px; line-height:1.5; margin:12px 0;">
        <h3 style="margin: 0 0 6px;">How to read this simulation</h3>
        <p style="margin: 0 0 8px;">Each square (block) is split into three horizontal bands:</p>
        <ul style="margin: 0 0 8px 18px; padding: 0;">
          <li><b>Top band — Density (ρ):</b> how crowded the block is.</li>
          <li><b>Middle band — Private gain (Δu):</b> the change in this agent’s utility if they move to this block.
          </li>
          <li><b>Bottom band — Social gain (ΔU):</b> the change in total social welfare (the sum of personal utility) if
            this agent moves to this
            block.</li>
        </ul>
        <p style="margin: 0 0 8px;"><b>Color depth</b> encodes magnitude within each metric (rank-equalized).</p>
        <p style="margin: 0 0 8px;">A <b>red outline</b> marks the agent’s current block during your turn.</p>
        <p style="margin: 0 0 8px;">
          <b>How to interact:</b> When it’s your turn, click on any block to select it as the destination.
          If you click the same block as the highlighted one, it means “stay”; otherwise, the agent will move to the
          selected block.
          The system will update the corresponding personal and social welfare.

        </p>
        <p style="margin: 0 0 8px;">
          Imagine that you are a resident of a city, and your preference about a block's utility is shown on the right.
          At the same time, every other citizens have the same preference as you and the sum of every citizens' utility,
          i.e., social welfare, is also shown on the right.
        </p>
        <summary><b>How to read this simulation</b></summary>
      </details>
      <div id="totalInfo">Total agents: 0</div>

      <div id="color-legend">
        <div style="margin-bottom: 4px; font-weight: bold;">Color legend</div>
        <div style="display: flex; align-items: center; margin-bottom: 6px;">
          <span style="width: 70px;">Density (ρ):</span>
          <canvas id="legendRho" width="200" height="20" style="border:1px solid #ccc;"></canvas>
          <span style="margin-left: 8px; font-size: 0.9em;">Low → High</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 6px;">
          <span style="width: 70px;">Δu:</span>
          <canvas id="legendDu" width="200" height="20" style="border:1px solid #ccc;"></canvas>
          <span style="margin-left: 8px; font-size: 0.9em;">Small → Large</span>
        </div>
        <div style="display: flex; align-items: center;">
          <span style="width: 70px;">ΔU:</span>
          <canvas id="legendDU" width="200" height="20" style="border:1px solid #ccc;"></canvas>
          <span style="margin-left: 8px; font-size: 0.9em;">Small → Large</span>
        </div>
      </div>

      <div id="turnInfo">Connecting...</div>
      <canvas id="cityCanvas" style="margin-top:10px;"></canvas>
    </div>

    <!-- 右列：固定信息面板（回合提示/曲线） -->
    <aside id="rightCol">
      <div class="panel">
        <h3>Utility Function u(ρ)</h3>
        <div class="chart-wrap"><canvas id="utilityChart"></canvas></div>
      </div>

      <div class="panel">
        <h3>Social Welfare Over Time</h3>
        <div class="chart-wrap"><canvas id="socialUtilityChart"></canvas></div>
      </div>
    </aside>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="app.js"></script>
</body>

</html>